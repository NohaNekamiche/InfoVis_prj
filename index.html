<html>
    <head> 
        <meta charset="utf-8">



        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <style type="text/css">
          svg {
            font: 10px sans-serif;
            shape-rendering: crispEdges;
          }
        
          .axis path,
          .axis line {
            fill: none;
            stroke: #000;
          }
         
          path.domain {
            stroke: none;
          }
         
          .y .tick line {
            stroke: #ddd;
          }
          input[type=file]{
          width: 100%;
          padding: 12px 20px;
          margin: 8px 0;
          display: inline-block;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
        }
                
        input[type=submit] {
          background-color: #4CAF50;
          color: white;
          padding: 12px 20px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          float: center;
        }
        input[type=submit]:hover {
        background-color: #45a049;
      }
      form {
    display: inline-block;
}
body {
    text-align: center;
}

          </style>
    </head>
    <body>
        <h1>Projet InfoVis : Visualisation des données avec D3js</h1>
      <form id="myForm">
        <label>Distribution des homme et femme fumeurs/alcoolique selon age</label>
        <input type="file" id="csvFile" accept=".csv" />
        <br />
        <input type="submit" value="Submit" />
      </form>
      <script>
        const myForm = document.getElementById("myForm");
        const csvFile = document.getElementById("csvFile");
     
        //convertir csv en une liste 'array'
        function csvToArray(str, delimiter = ",") {

          //utiliser un delimiteur pour creer array à partir d'une chaine de car'string'
          const headers = str.slice(0, str.indexOf("\n")).split(delimiter);
    
          // tranche de l'indice \n + 1 à la fin du texte
          // utiliser split pour créer un tableau de chaque ligne de valeur csv
          const rows = str.slice(str.indexOf("\n") + 1).split("\n");
          // mapper les lignes
          // divise les valeurs de chaque ligne dans un tableau
          // Utilisation de headers.reduce pour créer un objet.
          // Propriétés de l'objet dérivées de headers:values
          // L'objet est passé comme élément du tableau.
          const arr = rows.map(function (row) {
            const values = row.split(delimiter);
            const el = headers.reduce(function (object, header, index) {
              object[header] = values[index];
              return object;
            }, {});
            return el;
          });
    

          return arr;
        }
    
        myForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const input = csvFile.files[0];
          const reader = new FileReader();
         
          reader.onload = function (e) {
            const text = e.target.result;
            const data = csvToArray(text);

            var margin = {top: 20, right: 160, bottom: 35, left: 30};

        var width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

       
        var svg = d3.select("body")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

            // Transposer les données en layers
      
 
       var dataset = d3.layout.stack()(["homme_fum_alcoo", "homme_fum_non_alcoo",
        "homme_non_fume_non_alcoo","femme_fum_alcoo","femme_fum_non_alcoo",
        "femme_non_fum_non_alcoo"
        ].map(function(population) {
          
          return data.map(function(d) {
    
             if (isNaN(d[population])) d[population]= 0;
             console.log(parseInt(+d[population]))
            return {x:parseInt(d.age), y: parseInt(+d[population])};
          });
        }));
        // Set x, y and colors
       
        var x = d3.scale.ordinal()
          .domain(dataset[0].map(function(d) { 
           
            
            return (d.x); }))
          .rangeRoundBands([0, width+25], 0.1);

        var y = d3.scale.linear()
          .domain([0, d3.max(dataset, function(d) {  return d3.max(d, function(d) { return d.y0 + d.y; });  })])
          .range([height, 0]);

        var colors = ["#17265D","#555E7B","#7CCCE5", 
        "#732B26","#E04644","#F2A0A0"];
        // Define and draw axes
        var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(5)
        .tickSize(-width, 0, 0)
        .tickFormat( function(d) { return d } );

        var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .tickFormat(data.age); // change this to get x values to reflect new

        svg.append("g")
  .attr("class", "y axis")
  .call(yAxis);

svg.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + height + ")")
  .call(xAxis);


// Create groups for each series, rects for each segment 
var groups = svg.selectAll("g.cost")
  .data(dataset)
  .enter().append("g")
  .attr("class", "cost")
  .style("fill", function(d, i) { return colors[i]; });

var rect = groups.selectAll("rect")
  .data(function(d) { return d; })
  .enter()
  .append("rect")
  .attr("x", function(d) { return x(d.x) ; })
  .attr("y", function(d) { 
    
    if (isNaN(d.y)) d.y= 0;
    if (isNaN(d.y0)) d.y0= 0;
    console.log(d.y0, d.y)
    return y(d.y0 + d.y); })
  .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); })
  .attr("width", x.rangeBand())
  .on("mouseover", function() { tooltip.style("display", null); })
  .on("mouseout", function() { tooltip.style("display", "none"); })
  .on("mousemove", function(d) {
    var xPosition = d3.mouse(this)[0] - 15;
    var yPosition = d3.mouse(this)[1] - 25;
    tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
    tooltip.select("text").text(d.y);
  });



        // Draw legend
        var legend = svg.selectAll(".legend")
        .data(colors)
        .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(30," + i * 19 + ")"; });
        
        legend.append("rect")
        .attr("x", width - 18)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", function(d, i) {return colors.slice().reverse()[i];});
        
        legend.append("text")
        .attr("x", width + 5)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "start")
        .text(function(d, i) { 
            switch (i) {
            case 0: return "Femme-Non-Fumeur-Non-Alcoolique";
            case 1: return "Femme-Fumeur-Non-Alcoolique";
            case 2: return "Femme-Fumeur-Alcoolique";
            case 3: return  "Homme-Non-Fumeur-Non-Alcoolique";
            case 4:return "Homme-Fumeur-Non-Alcoolique";
            case 5: return     "Homme-Fumeur-Alcoolique";
        
       
        
            }
        });


        // Prep the tooltip bits, initial display is hidden
        var tooltip = svg.append("g")
        .attr("class", "tooltip")
        .style("display", "none");
            
        tooltip.append("rect")
        .attr("width", 30)
        .attr("height", 20)
        .attr("fill", "white")
        .style("opacity", 0.5);

        tooltip.append("text")
        .attr("x", 15)
        .attr("dy", "1.2em")
        .style("text-anchor", "middle")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("fill", "black")


          };
          
          reader.readAsText(input);
        });

      </script>

      
    </body>
</html>